<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Calendar Scheduler</title>

  <!-- Tailwind & FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Luxon for timezones -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- server.js must expose: createTeacherSlot, fetchTeacherSlots, deleteTeacherSlot, fetchBookedForSlot -->
  <script src="server.js"></script>

  <style>
    html, body { height: 100%; }
    .calendar-container { background: #fdfaf7; }
    #calendar-days div {
      background: #faf6f1; color: #3c2a1e; border-radius: .25rem;
      transition: background .2s;
    }
    #calendar-days div:hover { background: #f4e8dc; }
    #calendar-days div.bg-indigo-600 {
      background: #D4AF37 !important; color: #3c2a1e !important;
    }
    .time-slot {
      background: #faf6f1; border-color: #D4AF37; color: #3c2a1e;
      transition: background .2s, transform .2s;
      padding: 0.9rem 1rem;
      font-size: 1rem;
    }
    .time-slot:hover { background: #f4e8dc; transform: scale(1.02); }
    .time-slot.selected {
      background: #D4AF37; color: #3c2a1e; transform: scale(1.05);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    .calendar-container { transition: all 0.3s ease; }
    .time-slots-container {
      transition: all 0.3s ease;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
    }
    .time-slots-container.show { opacity: 1; max-height: 1000px; }
    @media (max-width: 768px) {
      .calendar-layout { flex-direction: column; }
      .time-slots-container.show { max-height: 500px; }
    }
    /* Taller list for desktop */
    #time-slots > div { max-height: 600px; overflow-y: auto; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Toggle & Add Slot -->
    <div class="flex justify-center items-center gap-4 mb-6">
      <!-- Optional: add a toggle if you want to switch views -->
      <!--
      <button id="switch-view-btn"
        class="px-4 py-2 bg-indigo-600 text-white rounded font-semibold hover:bg-indigo-700 transition">
        Switch to Teacher View
      </button>
      -->
      <button id="add-teacher-slot-btn"
        class="px-4 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition hidden">
        Add Teacher Slot
      </button>
    </div>

    <!-- Teacher Slot Modal -->
    <div id="teacher-slot-modal"
      class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Available Slot</h3>
        <div class="space-y-4">
          <!-- Teacher Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700">Teacher Name</label>
            <input
              type="text" id="teacher-name"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"
              placeholder="Your Name" required/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Date</label>
            <input type="date" id="teacher-slot-date"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Start Time</label>
            <input type="time" id="teacher-slot-start"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">End Time</label>
            <input type="time" id="teacher-slot-end"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Timezone</label>
            <select id="teacher-slot-tz"
              class="block w-full border border-gray-300 rounded-md py-2 px-3"></select>
          </div>
          <div class="flex justify-end gap-2">
            <button id="teacher-slot-cancel" class="px-4 py-2 bg-gray-200 rounded-md">
              Cancel
            </button>
            <button id="teacher-slot-save" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Calendar + Slots -->
    <div class="bg-white rounded-xl shadow-lg flex flex-col md:flex-row overflow-hidden calendar-layout">
      <!-- Calendar -->
      <div class="calendar-container w-full md:w-1/2 p-6 border-r border-gray-200">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold text-gray-800">Select a Date</h2>
          <div class="flex items-center space-x-2">
            <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-full">
              <i class="fas fa-chevron-left text-gray-600"></i>
            </button>
            <span id="current-month-year" class="font-medium text-gray-700"></span>
            <button id="next-month" class="p-2 hover:bg-gray-100 rounded-full">
              <i class="fas fa-chevron-right text-gray-600"></i>
            </button>
          </div>
        </div>
        <div class="mb-4 grid grid-cols-7 text-gray-500 text-sm">
          <div class="w-14 h-14 flex items-center justify-center">Sun</div>
          <div class="w-14 h-14 flex items-center justify-center">Mon</div>
          <div class="w-14 h-14 flex items-center justify-center">Tue</div>
          <div class="w-14 h-14 flex items-center justify-center">Wed</div>
          <div class="w-14 h-14 flex items-center justify-center">Thu</div>
          <div class="w-14 h-14 flex items-center justify-center">Fri</div>
          <div class="w-14 h-14 flex items-center justify-center">Sat</div>
        </div>
        <div id="calendar-days" class="grid grid-cols-7 gap-1"></div>
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">Your Timezone</label>
          <select id="timezone-select"
            class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
        </div>
      </div>

      <!-- Time Slots -->
      <div class="w-full md:w-1/2 p-6 flex flex-col items-start md:items-end">
        <div class="mb-2 w-full md:w-auto">
          <h2 class="text-xl font-semibold text-gray-800 md:text-right text-left">Available Time Slots</h2>
          <p id="selected-date-text" class="text-gray-500 mt-1 md:text-right text-left">Please select a date</p>
        </div>
        <div id="time-slots" class="time-slots-container w-full md:w-96">
          <div class="grid gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[calendar.html] DOM ready');

      // --- State & DOM refs ---
      let currentDate = new Date();
      let selectedDate = null;
      let isTeacherView = false; // toggleable if you want
      let teacherSlots = [];
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      console.log('[calendar.html] Detected user timezone:', userTimezone);

      const calendarDays = document.getElementById('calendar-days');
      const currentMonthYear = document.getElementById('current-month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');
      const timezoneSelect = document.getElementById('timezone-select');
      const selectedDateText = document.getElementById('selected-date-text');
      const timeSlotsContainer = document.getElementById('time-slots');
      const addTeacherSlotBtn = document.getElementById('add-teacher-slot-btn');
      const teacherSlotModal = document.getElementById('teacher-slot-modal');
      const teacherNameInput = document.getElementById('teacher-name');
      const teacherSlotDate = document.getElementById('teacher-slot-date');
      const teacherSlotStart = document.getElementById('teacher-slot-start');
      const teacherSlotEnd = document.getElementById('teacher-slot-end');
      const teacherSlotTz = document.getElementById('teacher-slot-tz');
      const teacherSlotCancel = document.getElementById('teacher-slot-cancel');
      const teacherSlotSave = document.getElementById('teacher-slot-save');

      const { DateTime } = luxon;

      const popularTimezones = [
        "Asia/Kolkata","Asia/Dubai","Asia/Singapore","Asia/Tokyo",
        "Europe/London","Europe/Berlin","Europe/Paris","Europe/Moscow",
        "America/New_York","America/Chicago","America/Denver","America/Los_Angeles",
        "Australia/Sydney"
      ];

      // ── Calendar Rendering ───────────────────────────────────
      function renderCalendar() {
        console.log('[calendar.html] renderCalendar for', currentDate);
        calendarDays.innerHTML = '';
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth();

        currentMonthYear.textContent = new Date(y,m,1)
          .toLocaleDateString('en-US',{month:'long',year:'numeric'});

        const firstDay = new Date(y,m,1).getDay();
        const daysInMonth = new Date(y,m+1,0).getDate();
        const prevMonthDays = new Date(y,m,0).getDate();

        // prev month
        for(let i=0;i<firstDay;i++){
          const d = prevMonthDays-firstDay+i+1;
          const el = createDayElement(d);
          el.classList.add('text-gray-400');
          calendarDays.appendChild(el);
        }
        // this month
        for(let d=1; d<=daysInMonth; d++){
          const el = createDayElement(d);
          const today = new Date();
          if(y===today.getFullYear() && m===today.getMonth() && d===today.getDate()){
            el.classList.add('bg-indigo-100','font-semibold');
          }
          if(selectedDate && y===selectedDate.getFullYear() && m===selectedDate.getMonth() && d===selectedDate.getDate()){
            el.classList.add('bg-indigo-600','text-white');
          }
          calendarDays.appendChild(el);
        }
        // next month fillers
        const total = firstDay+daysInMonth;
        const rem = (7 - total%7)%7;
        for(let i=1;i<=rem;i++){
          const el = createDayElement(i);
          el.classList.add('text-gray-400');
          calendarDays.appendChild(el);
        }
      }

      function createDayElement(day) {
        const el = document.createElement('div');
        el.className = 'w-14 h-14 flex items-center justify-center text-base font-medium rounded-full cursor-pointer hover:bg-gray-100';
        el.textContent = day;
        el.addEventListener('click', async () => {
          const y = currentDate.getFullYear();
          const m = currentDate.getMonth();

          // skip out-of-month days
          if(el.classList.contains('text-gray-400')) {
            console.log('[calendar.html] clicked out-of-month day, ignore');
            return;
          }

          selectedDate = new Date(y,m,day);
          const dateStr = formatLocalDate(selectedDate);
          console.log('[calendar.html] selected date:', selectedDate, '=>', dateStr);

          try {
            teacherSlots = await fetchTeacherSlots(dateStr);
            console.log('[calendar.html] fetched teacher slots:', teacherSlots);
          } catch(e){
            console.error('[calendar.html] fetchTeacherSlots error:', e);
            teacherSlots = [];
          }
          renderCalendar();
          showTimeSlots();
        });
        return el;
      }

      function formatLocalDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      }

      // ── Populate Timezones ───────────────────────────────────
      function populateTimezones() {
        console.log('[calendar.html] populateTimezones');
        timezoneSelect.innerHTML = '';
        popularTimezones.forEach(tz=>{
          const o = document.createElement('option');
          o.value = tz;
          o.textContent = tz.replace('_',' ');
          if(tz===userTimezone) o.selected=true;
          timezoneSelect.appendChild(o);
        });
        if(!popularTimezones.includes(userTimezone)){
          const o = document.createElement('option');
          o.value=userTimezone;
          o.textContent=userTimezone+' (detected)';
          timezoneSelect.insertBefore(o, timezoneSelect.firstChild);
        }
      }
      
      function populateTeacherTz(){
        console.log('[calendar.html] populateTeacherTz');
        teacherSlotTz.innerHTML = '';
        popularTimezones.forEach(tz=>{
          const o = document.createElement('option');
          o.value=tz;
          o.textContent=tz.replace('_',' ');
          if(tz==='Asia/Kolkata') o.selected=true;
          teacherSlotTz.appendChild(o);
        });
      }

      // ── Show Time Slots (student + teacher) ──────────────────
      async function showTimeSlots() {
        console.log('[calendar.html] showTimeSlots, isTeacherView:', isTeacherView);
        if(!selectedDate) {
          console.log('[calendar.html] no selectedDate, return');
          return;
        }

        const dateStr = formatLocalDate(selectedDate);
        selectedDateText.textContent = selectedDate
          .toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});

        const grid = document.querySelector('#time-slots > div');
        grid.innerHTML = '';

        if(isTeacherView) {
          console.log('[calendar.html] teacher view render');
          if(!teacherSlots.length){
            grid.innerHTML = '<div class="text-gray-500">No slots for this date.</div>';
          } else {
            teacherSlots.forEach(slot => {
              const div = document.createElement('div');
              div.className = 'flex justify-between items-center bg-indigo-100 border border-indigo-300 rounded-md p-3 mb-2';
              div.innerHTML = `
                <span class="font-medium text-gray-800">
                  ${slot.start_time} – ${slot.end_time} (${slot.timezone})
                </span>
                <button data-id="${slot.id}" class="text-red-600 hover:text-red-800">Delete</button>
              `;
              div.querySelector('button').onclick = async e => {
                console.log('[calendar.html] delete slot clicked:', slot.id);
                try {
                  await deleteTeacherSlot(slot.id);
                  teacherSlots = teacherSlots.filter(s=>s.id!==slot.id);
                  showTimeSlots();
                } catch(err) {
                  console.error('[calendar.html] deleteTeacherSlot error:', err);
                  alert('Delete failed: '+err.message);
                }
              };
              grid.appendChild(div);
            });
          }
          timeSlotsContainer.classList.add('show');
          return;
        }

        // ───────── Student view with booked filtering ─────────
        if (teacherSlots.length) {
          console.log('[calendar.html] student view render');
          const s = teacherSlots[0]; // current UI uses the first slot
          console.log('[calendar.html] slot chosen for student view:', s);

          // fetch booked rows for this slot/date
          let booked = [];
          try {
            booked = await window.fetchBookedForSlot(s.id, s.date);
            console.log('[calendar.html] booked rows (by slot/date):', booked);
          } catch (err) {
            console.error('[calendar.html] fetchBookedForSlot error:', err);
          }

          const { DateTime } = luxon;

          // normalize booked intervals into user's timezone
          const bookedIntervals = booked.map(b => {
            const bs = DateTime.fromISO(`${b.date}T${b.start_time}`, { zone: b.timezone }).setZone(userTimezone);
            const be = DateTime.fromISO(`${b.date}T${b.end_time}`,   { zone: b.timezone }).setZone(userTimezone);
            return { start: bs, end: be };
          });
          console.log('[calendar.html] normalized booked intervals:', bookedIntervals);

          function overlapsAny(aStart, aEnd) {
            return bookedIntervals.some(({start, end}) => aStart < end && aEnd > start);
          }

          let start = DateTime.fromISO(`${s.date}T${s.start_time}`, { zone: s.timezone }).setZone(userTimezone);
          const end = DateTime.fromISO(`${s.date}T${s.end_time}`,   { zone: s.timezone }).setZone(userTimezone);
          console.log('[calendar.html] user-range:', start.toISO(), '=>', end.toISO(), 'tz:', userTimezone);

          while (start < end) {
            const next = start.plus({ hours: 1 }) < end ? start.plus({ hours: 1 }) : end;

            if (!overlapsAny(start, next)) {
              const btn = document.createElement('button');
              btn.className = 'time-slot border rounded-md p-3';
              btn.textContent = `${start.toFormat('hh:mm a')} – ${next.toFormat('hh:mm a')}`;
              btn.onclick = () => {
                console.log('[calendar.html] selected time label:', btn.textContent);
                document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                btn.classList.add('selected');

                window.parent.postMessage({
                  type: 'calendar-info',
                  slot_id: s.id,
                  date: s.date,
                  time: btn.textContent,
                  timezone: userTimezone
                }, '*');
              };
              grid.appendChild(btn);
            } else {
              console.log('[calendar.html] SKIP booked block:', start.toFormat('hh:mm a'), '–', next.toFormat('hh:mm a'));
            }

            start = next;
          }

          timeSlotsContainer.classList.add('show');
        } else {
          console.log('[calendar.html] no teacher slots for this date');
          grid.innerHTML = '<div class="text-gray-500">No classes scheduled.</div>';
          timeSlotsContainer.classList.add('show');
        }
      }

      // ── Event Listeners ───────────────────────────────────────
      prevMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
      nextMonthBtn.onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
      timezoneSelect.onchange = () => { userTimezone = timezoneSelect.value; console.log('[calendar.html] tz changed =>', userTimezone); showTimeSlots(); };

      // Optional view toggle (uncomment button above first)
      // const switchViewBtn = document.getElementById('switch-view-btn');
      // if (switchViewBtn) {
      //   switchViewBtn.onclick = () => {
      //     isTeacherView = !isTeacherView;
      //     switchViewBtn.textContent = isTeacherView ? 'Switch to Student View' : 'Switch to Teacher View';
      //     addTeacherSlotBtn.classList.toggle('hidden', !isTeacherView);
      //     showTimeSlots();
      //   };
      // }

      addTeacherSlotBtn.onclick = () => {
        console.log('[calendar.html] show teacher slot modal');
        teacherSlotModal.classList.remove('hidden');
        teacherNameInput.value = '';
        teacherSlotDate.value = '';
        teacherSlotStart.value = '';
        teacherSlotEnd.value = '';
      };
      
      teacherSlotCancel.onclick = () => { 
        console.log('[calendar.html] close teacher slot modal');
        teacherSlotModal.classList.add('hidden'); 
      };

      teacherSlotSave.onclick = async () => {
        const name = teacherNameInput.value.trim();
        const date = teacherSlotDate.value;
        const start = teacherSlotStart.value;
        const end = teacherSlotEnd.value;
        const tz = teacherSlotTz.value;
        if(!name || !date || !start || !end) {
          console.warn('[calendar.html] teacher slot validation failed');
          return;
        }
        try {
          console.log('[calendar.html] createTeacherSlot payload:', { teacher_name: name, date, start_time: start, end_time: end, timezone: tz });
          const slot = await createTeacherSlot({ teacher_name: name, date, start_time: start, end_time: end, timezone: tz });
          console.log('[calendar.html] slot created:', slot);
          teacherSlots.push(slot);
          teacherSlotModal.classList.add('hidden');
          showTimeSlots();
        } catch(err){
          console.error('[calendar.html] createTeacherSlot error:', err);
          alert('Save failed: '+err.message);
        }
      };

      // ── Init ─────────────────────────────────────────────────
      console.log('[calendar.html] init start');
      renderCalendar();
      populateTimezones();
      populateTeacherTz();
      console.log('[calendar.html] init done');
    });
  </script>
</body>
</html>
