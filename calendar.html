<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Calendar Scheduler</title>

  <!-- Tailwind & FontAwesome -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Luxon for timezones -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="server.js"></script>

  <style>
    /* (All your existing styles remain the same) */
    .calendar-container { background: #fdfaf7; }
    #calendar-days div {
      background: #faf6f1; color: #3c2a1e; border-radius: .25rem;
      transition: background .2s;
    }
    #calendar-days div:hover { background: #f4e8dc; }
    #calendar-days div.bg-indigo-600 {
      background: #D4AF37 !important; color: #3c2a1e !important;
    }
    .time-slot {
      background: #faf6f1; border-color: #D4AF37; color: #3c2a1e;
      transition: background .2s, transform .2s;
    }
    .time-slot:hover { background: #f4e8dc; }
    .time-slot.selected {
      background: #D4AF37; color: #3c2a1e; transform: scale(1.05);
    }
    .calendar-container {
      transition: all 0.3s ease;
    }
    .time-slots-container {
      transition: all 0.3s ease;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
    }
    .time-slots-container.show {
      opacity: 1;
      max-height: 1000px;
    }
    .time-slot {
      transition: all 0.2s ease;
    }
    .time-slot:hover {
      transform: scale(1.02);
    }
    .time-slot.selected {
      transform: scale(1.05);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    @media (max-width: 768px) {
      .calendar-layout {
        flex-direction: column;
      }
      .time-slots-container.show {
        max-height: 500px;
      }
    }
    #time-slots > div {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- (All your HTML remains the same) -->
  <div class="container mx-auto px-4 py-8">
    <!-- Toggle & Add Slot -->
    <div class="flex justify-center items-center gap-4 mb-6">
      <button id="switch-view-btn"
        class="px-4 py-2 bg-indigo-600 text-white rounded font-semibold hover:bg-indigo-700 transition">
        Switch to Teacher View
      </button>
      <button id="add-teacher-slot-btn"
        class="px-4 py-2 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition hidden">
        Add Teacher Slot
      </button>
    </div>

    <!-- Teacher Slot Modal -->
    <div id="teacher-slot-modal"
      class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50">
      <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Add Available Slot</h3>
        <div class="space-y-4">
          <!-- Teacher Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700">Teacher Name</label>
            <input
              type="text" id="teacher-name"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"
              placeholder="Your Name" required/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Date</label>
            <input type="date" id="teacher-slot-date"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Start Time</label>
            <input type="time" id="teacher-slot-start"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">End Time</label>
            <input type="time" id="teacher-slot-end"
              class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Timezone</label>
            <select id="teacher-slot-tz"
              class="block w-full border border-gray-300 rounded-md py-2 px-3"></select>
          </div>
          <div class="flex justify-end gap-2">
            <button id="teacher-slot-cancel" class="px-4 py-2 bg-gray-200 rounded-md">
              Cancel
            </button>
            <button id="teacher-slot-save" class="px-4 py-2 bg-indigo-600 text-white rounded-md">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Calendar + Slots -->
    <div class="bg-white rounded-xl shadow-lg flex flex-col md:flex-row overflow-hidden calendar-layout">
      <!-- Calendar -->
      <div class="calendar-container w-full md:w-1/2 p-6 border-r border-gray-200">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold text-gray-800">Select a Date</h2>
          <div class="flex items-center space-x-2">
            <button id="prev-month" class="p-2 hover:bg-gray-100 rounded-full">
              <i class="fas fa-chevron-left text-gray-600"></i>
            </button>
            <span id="current-month-year" class="font-medium text-gray-700"></span>
            <button id="next-month" class="p-2 hover:bg-gray-100 rounded-full">
              <i class="fas fa-chevron-right text-gray-600"></i>
            </button>
          </div>
        </div>
        <div class="mb-4 grid grid-cols-7 text-gray-500 text-sm">
          <div class="w-10 h-10 flex items-center justify-center">Sun</div>
          <div class="w-10 h-10 flex items-center justify-center">Mon</div>
          <div class="w-10 h-10 flex items-center justify-center">Tue</div>
          <div class="w-10 h-10 flex items-center justify-center">Wed</div>
          <div class="w-10 h-10 flex items-center justify-center">Thu</div>
          <div class="w-10 h-10 flex items-center justify-center">Fri</div>
          <div class="w-10 h-10 flex items-center justify-center">Sat</div>
        </div>
        <div id="calendar-days" class="grid grid-cols-7 gap-1"></div>
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-1">Your Timezone</label>
          <select id="timezone-select"
            class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"></select>
        </div>
      </div>

      <!-- Time Slots -->
      <div class="w-full md:w-1/2 p-6 flex flex-col items-start md:items-end">
        <div class="mb-2 w-full md:w-auto">
          <h2 class="text-xl font-semibold text-gray-800 md:text-right text-left">Available Time Slots</h2>
          <p id="selected-date-text" class="text-gray-500 mt-1 md:text-right text-left">Please select a date</p>
        </div>
        <div id="time-slots" class="time-slots-container w-full md:w-96">
          <div class="grid gap-3"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM fully loaded and parsed');
      
      // --- State & DOM refs ---
      let currentDate = new Date();
      console.log('Initial currentDate:', currentDate);
      
      let selectedDate = null;
      let isTeacherView = false;
      let teacherSlots = [];
      let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      console.log('Detected user timezone:', userTimezone);

      const calendarDays = document.getElementById('calendar-days');
      const currentMonthYear = document.getElementById('current-month-year');
      const prevMonthBtn = document.getElementById('prev-month');
      const nextMonthBtn = document.getElementById('next-month');
      const timezoneSelect = document.getElementById('timezone-select');
      const selectedDateText = document.getElementById('selected-date-text');
      const timeSlotsContainer = document.getElementById('time-slots');
      const switchViewBtn = document.getElementById('switch-view-btn');
      const addTeacherSlotBtn = document.getElementById('add-teacher-slot-btn');
      const teacherSlotModal = document.getElementById('teacher-slot-modal');
      const teacherNameInput = document.getElementById('teacher-name');
      const teacherSlotDate = document.getElementById('teacher-slot-date');
      const teacherSlotStart = document.getElementById('teacher-slot-start');
      const teacherSlotEnd = document.getElementById('teacher-slot-end');
      const teacherSlotTz = document.getElementById('teacher-slot-tz');
      const teacherSlotCancel = document.getElementById('teacher-slot-cancel');
      const teacherSlotSave = document.getElementById('teacher-slot-save');

      const { DateTime } = luxon;
      console.log('Luxon DateTime loaded:', DateTime);
      
      const popularTimezones = [
        "Asia/Kolkata","Asia/Dubai","Asia/Singapore","Asia/Tokyo",
        "Europe/London","Europe/Berlin","Europe/Paris","Europe/Moscow",
        "America/New_York","America/Chicago","America/Denver","America/Los_Angeles",
        "Australia/Sydney"
      ];

      // ── Calendar Rendering ───────────────────────────────────
      function renderCalendar() {
        console.log('Rendering calendar for:', currentDate);
        
        calendarDays.innerHTML = '';
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth();
        
        currentMonthYear.textContent = new Date(y,m,1)
          .toLocaleDateString('en-US',{month:'long',year:'numeric'});
        console.log('Month/year display:', currentMonthYear.textContent);
        
        const firstDay = new Date(y,m,1).getDay();
        const daysInMonth = new Date(y,m+1,0).getDate();
        const prevMonthDays = new Date(y,m,0).getDate();
        
        console.log(`Calendar details - First day: ${firstDay}, Days in month: ${daysInMonth}, Prev month days: ${prevMonthDays}`);

        // prev month
        for(let i=0;i<firstDay;i++){
          const d = prevMonthDays-firstDay+i+1;
          const el = createDayElement(d);
          el.classList.add('text-gray-400');
          calendarDays.appendChild(el);
        }
        
        // this month
        for(let d=1; d<=daysInMonth; d++){
          const el = createDayElement(d);
          const today = new Date();
          if(y===today.getFullYear() && m===today.getMonth() && d===today.getDate()){
            console.log('Highlighting today:', d);
            el.classList.add('bg-indigo-100','font-semibold');
          }
          if(selectedDate && y===selectedDate.getFullYear() && m===selectedDate.getMonth() && d===selectedDate.getDate()){
            console.log('Highlighting selected date:', d);
            el.classList.add('bg-indigo-600','text-white');
          }
          calendarDays.appendChild(el);
        }
        
        // next month
        const total = firstDay+daysInMonth;
        const rem = (7 - total%7)%7;
        console.log(`Adding ${rem} days from next month`);
        
        for(let i=1;i<=rem;i++){
          const el = createDayElement(i);
          el.classList.add('text-gray-400');
          calendarDays.appendChild(el);
        }
      }

      function createDayElement(day) {
        console.log('Creating day element:', day);
        const el = document.createElement('div');
        el.className = 'w-10 h-10 flex items-center justify-center text-sm font-medium rounded-full cursor-pointer hover:bg-gray-100';
        el.textContent = day;
        el.addEventListener('click', async () => {
          const y = currentDate.getFullYear();
          const m = currentDate.getMonth();
          
          // skip out-of-month days
          if(el.classList.contains('text-gray-400')) {
            console.log('Clicked out-of-month day, ignoring');
            return;
          }
          
          selectedDate = new Date(y,m,day);
          console.log('Date selected:', selectedDate);
          
          // fetch live slots - FIXED DATE FORMAT HERE
          const dateStr = formatLocalDate(selectedDate);
          console.log('Fetching slots for date:', dateStr);
          
          try {
            teacherSlots = await fetchTeacherSlots(dateStr);
            console.log('Fetched teacher slots:', teacherSlots);
          } catch(e){
            console.error('Error fetching teacher slots:', e);
            teacherSlots = [];
          }
          renderCalendar();
          showTimeSlots();
        });
        return el;
      }

      // Helper function to format dates correctly (FIX FOR DATE OFFSET)
      function formatLocalDate(date) {
        return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      }

      // ── Populate Timezones ───────────────────────────────────
      function populateTimezones() {
        console.log('Populating timezone dropdown');
        timezoneSelect.innerHTML = '';
        popularTimezones.forEach(tz=>{
          const o = document.createElement('option');
          o.value = tz;
          o.textContent = tz.replace('_',' ');
          if(tz===userTimezone) o.selected=true;
          timezoneSelect.appendChild(o);
        });
        if(!popularTimezones.includes(userTimezone)){
          const o = document.createElement('option');
          o.value=userTimezone;
          o.textContent=userTimezone+' (detected)';
          timezoneSelect.insertBefore(o, timezoneSelect.firstChild);
        }
        console.log('Timezone dropdown populated with:', timezoneSelect.innerHTML);
      }
      
      function populateTeacherTz(){
        console.log('Populating teacher timezone dropdown');
        teacherSlotTz.innerHTML = '';
        popularTimezones.forEach(tz=>{
          const o = document.createElement('option');
          o.value=tz;
          o.textContent=tz.replace('_',' ');
          if(tz==='Asia/Kolkata') o.selected=true;
          teacherSlotTz.appendChild(o);
        });
      }

      // ── Show Time Slots ───────────────────────────────────────
      function showTimeSlots() {
        console.log('Showing time slots, isTeacherView:', isTeacherView);
        
        if(!selectedDate) {
          console.log('No date selected, skipping');
          return;
        }
        
        // FIXED DATE FORMAT HERE
        const dateStr = formatLocalDate(selectedDate);
        selectedDateText.textContent = selectedDate
          .toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
        
        console.log('Selected date text:', selectedDateText.textContent);
        
        const grid = document.querySelector('#time-slots > div');
        grid.innerHTML = '';

        if(isTeacherView) {
          console.log('Rendering teacher view slots');
          
          if(!teacherSlots.length){
            console.log('No teacher slots found for this date');
            grid.innerHTML = '<div class="text-gray-500">No slots for this date.</div>';
          } else {
            console.log('Rendering', teacherSlots.length, 'teacher slots');
            teacherSlots.forEach(slot => {
              const div = document.createElement('div');
              div.className = 'flex justify-between items-center bg-indigo-100 border border-indigo-300 rounded-md p-3 mb-2';
              div.innerHTML = `
                <span class="font-medium text-gray-800">
                  ${slot.start_time} – ${slot.end_time} (${slot.timezone})
                </span>
                <button data-id="${slot.id}" class="text-red-600 hover:text-red-800">Delete</button>
              `;
              div.querySelector('button').onclick = async e => {
                console.log('Delete button clicked for slot:', slot.id);
                try {
                  await deleteTeacherSlot(slot.id);
                  teacherSlots = teacherSlots.filter(s=>s.id!==slot.id);
                  console.log('Slot deleted, remaining slots:', teacherSlots);
                  showTimeSlots();
                } catch(err) {
                  console.error('Delete failed:', err);
                  alert('Delete failed: '+err.message);
                }
              };
              grid.appendChild(div);
            });
          }
          timeSlotsContainer.classList.add('show');
          return;
        }

        // student view: show hourly breakdown for single slot
        if(teacherSlots.length){
          console.log('Rendering student view slots');
          const s = teacherSlots[0];
          console.log('First teacher slot:', s);
          
          let start = DateTime.fromISO(`${s.date}T${s.start_time}`, {zone:s.timezone})
                        .setZone(userTimezone);
          const end = DateTime.fromISO(`${s.date}T${s.end_time}`, {zone:s.timezone})
                        .setZone(userTimezone);
          
          console.log('Start time (converted):', start.toString());
          console.log('End time (converted):', end.toString());
          
          while(start < end){
            const next = start.plus({hours:1})<end ? start.plus({hours:1}) : end;
            const btn = document.createElement('button');
            btn.className = 'time-slot border rounded-md p-3';
            btn.textContent = `${start.toFormat('hh:mm a')} – ${next.toFormat('hh:mm a')}`;
            btn.onclick = () => {
              console.log('Time slot selected:', btn.textContent);
              document.querySelectorAll('.time-slot')
                .forEach(el=>el.classList.remove('selected'));
              btn.classList.add('selected');
              // propagate selection...
              window.parent.postMessage({
                type:'calendar-info',
                date:s.date,
                time:btn.textContent,
                timezone:userTimezone
              },'*');
            };
            grid.appendChild(btn);
            start = next;
          }
        } else {
          console.log('No teacher slots available for student view');
          grid.innerHTML = '<div class="text-gray-500">No classes scheduled.</div>';
        }
        timeSlotsContainer.classList.add('show');
      }

      // ── Event Listeners ───────────────────────────────────────
      prevMonthBtn.onclick = () => { 
        console.log('Previous month button clicked');
        currentDate.setMonth(currentDate.getMonth()-1); 
        renderCalendar(); 
      };
      
      nextMonthBtn.onclick = () => { 
        console.log('Next month button clicked');
        currentDate.setMonth(currentDate.getMonth()+1); 
        renderCalendar(); 
      };
      
      timezoneSelect.onchange = () => { 
        userTimezone = timezoneSelect.value;
        console.log('Timezone changed to:', userTimezone); 
        showTimeSlots(); 
      };

      switchViewBtn.onclick = () => {
        isTeacherView = !isTeacherView;
        console.log('View switched to:', isTeacherView ? 'Teacher' : 'Student');
        switchViewBtn.textContent = isTeacherView ? 'Switch to Student View' : 'Switch to Teacher View';
        addTeacherSlotBtn.classList.toggle('hidden', !isTeacherView);
        showTimeSlots();
      };

      addTeacherSlotBtn.onclick = () => {
        console.log('Add teacher slot button clicked');
        teacherSlotModal.classList.remove('hidden');
        teacherNameInput.value = '';
        teacherSlotDate.value = '';
        teacherSlotStart.value = '';
        teacherSlotEnd.value = '';
      };
      
      teacherSlotCancel.onclick = () => {
        console.log('Teacher slot modal cancelled');
        teacherSlotModal.classList.add('hidden');
      };

      teacherSlotSave.onclick = async () => {
        const name = teacherNameInput.value.trim();
        const date = teacherSlotDate.value;
        const start = teacherSlotStart.value;
        const end = teacherSlotEnd.value;
        const tz = teacherSlotTz.value;
        
        console.log('Saving teacher slot:', { name, date, start, end, tz });
        
        if(!name || !date || !start || !end) {
          console.log('Validation failed - missing fields');
          return;
        }
        
        try {
          const slot = await createTeacherSlot({ 
            teacher_name: name, 
            date, 
            start_time: start, 
            end_time: end, 
            timezone: tz 
          });
          
          console.log('Slot created:', slot);
          teacherSlots.push(slot);
          teacherSlotModal.classList.add('hidden');
          showTimeSlots();
        } catch(err){
          console.error('Save failed:', err);
          alert('Save failed: '+err.message);
        }
      };

      // ── Init ─────────────────────────────────────────────────
      console.log('Initializing calendar...');
      renderCalendar();
      populateTimezones();
      populateTeacherTz();
      console.log('Calendar initialized');
    });
  </script>
</body>
</html>