<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Calendar Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        .calendar-container {
            transition: all 0.3s ease;
        }
        .time-slots-container {
            transition: all 0.3s ease;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
        }
        .time-slots-container.show {
            opacity: 1;
            max-height: 1000px;
        }
        .time-slot {
            transition: all 0.2s ease;
        }
        .time-slot:hover {
            transform: scale(1.02);
        }
        .time-slot.selected {
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        @media (max-width: 768px) {
            .calendar-layout {
                flex-direction: column;
            }
            .time-slots-container.show {
                max-height: 500px;
            }
        }

        #time-slots > div {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-6xl mx-auto">

            <!-- Switch view and teacher slot modal -->
            <div class="flex justify-center items-center gap-4 mb-6">
                <button id="switch-view-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md font-semibold hover:bg-indigo-700 transition">
                    Switch to Teacher View
                </button>
                <button id="add-teacher-slot-btn" class="px-4 py-2 bg-green-600 text-white rounded-md font-semibold hover:bg-green-700 transition hidden">
                    Add Teacher Slot
                </button>
            </div>
            <!-- Modal for adding teacher slot -->
            <div id="teacher-slot-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50">
                <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add Available Slot</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="teacher-slot-date" class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Start Time</label>
                            <input type="time" id="teacher-slot-start" class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">End Time</label>
                            <input type="time" id="teacher-slot-end" class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Timezone</label>
                            <select id="teacher-slot-tz" class="block w-full border border-gray-300 rounded-md py-2 px-3"></select>
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button id="teacher-slot-cancel" class="px-4 py-2 bg-gray-200 rounded-md">Cancel</button>
                            <button id="teacher-slot-save" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden calendar-layout flex flex-col md:flex-row">
                <!-- Calendar Section -->
                <div class="calendar-container w-full md:w-1/2 p-6 border-r border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Select a Date</h2>
                        <div class="flex items-center space-x-2">
                            <span id="current-month-year" class="font-medium text-gray-700">June 2023</span>
                            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-100">
                                <i class="fas fa-chevron-left text-gray-600"></i>
                            </button>
                            <button id="next-month" class="p-2 rounded-full hover:bg-gray-100">
                                <i class="fas fa-chevron-right text-gray-600"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-4 flex justify-between">
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Sun</div>
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Mon</div>
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Tue</div>
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Wed</div>
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Thu</div>
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Fri</div>
                        <div class="w-10 h-10 flex items-center justify-center text-sm font-medium text-gray-500">Sat</div>
                    </div>

                    <div id="calendar-days" class="grid grid-cols-7 gap-1"></div>

                    <div class="mt-6">
                        <label for="timezone-select" class="block text-sm font-medium text-gray-700 mb-1">Timezone</label>
                        <div class="relative">
                            <select id="timezone-select" class="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                <!-- Timezones will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Time Slots Section -->
                <div class="w-full md:w-1/2 p-6 flex flex-col items-start md:items-end">
                    <div id="selected-date-display" class="mb-2 w-full md:w-auto">
                        <h2 class="text-xl font-semibold text-gray-800 md:text-right text-left">Available Time Slots</h2>
                        <p id="selected-date-text" class="text-gray-500 mt-1 md:text-right text-left">Please select a date from the calendar</p>
                    </div>
                    <div id="time-slots" class="time-slots-container w-full md:w-96">
                        <div class="grid grid-cols-1 gap-3">
                            <!-- Time slots will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Current date and timezone
            let currentDate = new Date();
            let selectedDate = null;
            let selectedTimeSlot = null;
            let eventDuration = 60; // Default duration in minutes
            let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

            // DOM Elements
            const calendarDays = document.getElementById('calendar-days');
            const currentMonthYear = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const timezoneSelect = document.getElementById('timezone-select');
            const selectedDateText = document.getElementById('selected-date-text');
            const timeSlotsContainer = document.getElementById('time-slots');
            const switchViewBtn = document.getElementById('switch-view-btn');
            const addTeacherSlotBtn = document.getElementById('add-teacher-slot-btn');
            const teacherSlotModal = document.getElementById('teacher-slot-modal');
            const teacherSlotDate = document.getElementById('teacher-slot-date');
            const teacherSlotStart = document.getElementById('teacher-slot-start');
            const teacherSlotEnd = document.getElementById('teacher-slot-end');
            const teacherSlotTz = document.getElementById('teacher-slot-tz');
            const teacherSlotCancel = document.getElementById('teacher-slot-cancel');
            const teacherSlotSave = document.getElementById('teacher-slot-save');

            // Switch view logic
            let isTeacherView = false;
            let teacherSlots = []; // {date: 'YYYY-MM-DD', start: 'HH:MM', end: 'HH:MM', tz: 'Asia/Kolkata'}

            // Initialize the calendar
            function initCalendar() {
                renderCalendar();
                populateTimezones();
                setupEventListeners();
                populateTeacherTz();
            }

            // Render the calendar for the current month
            function renderCalendar() {
                calendarDays.innerHTML = '';

                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();

                // Update month/year display
                currentMonthYear.textContent = new Date(year, month, 1).toLocaleDateString('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                });

                // Get first day of month and total days in month
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Get days from previous month
                const prevMonthDays = new Date(year, month, 0).getDate();

                // Add days from previous month
                for (let i = 0; i < firstDay; i++) {
                    const dayElement = createDayElement(prevMonthDays - firstDay + i + 1);
                    dayElement.classList.add('text-gray-400');
                    calendarDays.appendChild(dayElement);
                }

                // Add days from current month
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayElement = createDayElement(i);

                    // Highlight today
                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && i === today.getDate()) {
                        dayElement.classList.add('bg-indigo-100', 'font-semibold');
                    }

                    // Highlight selected date
                    if (selectedDate && year === selectedDate.getFullYear() && month === selectedDate.getMonth() && i === selectedDate.getDate()) {
                        dayElement.classList.add('bg-indigo-600', 'text-white');
                    }

                    calendarDays.appendChild(dayElement);
                }

                // Add days from next month
                const totalDays = firstDay + daysInMonth;
                const remainingDays = 7 - (totalDays % 7);
                if (remainingDays < 7) {
                    for (let i = 1; i <= remainingDays; i++) {
                        const dayElement = createDayElement(i);
                        dayElement.classList.add('text-gray-400');
                        calendarDays.appendChild(dayElement);
                    }
                }
            }

            // Create a day element for the calendar
            function createDayElement(day) {
                const dayElement = document.createElement('div');
                dayElement.className = 'w-10 h-10 flex items-center justify-center text-sm font-medium rounded-full cursor-pointer hover:bg-gray-100';
                dayElement.textContent = day;

                dayElement.addEventListener('click', function() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();

                    // Check if this is a day from current month
                    if (!dayElement.classList.contains('text-gray-400')) {
                        selectedDate = new Date(year, month, day);
                        renderCalendar();
                        showTimeSlots();
                    }
                });

                return dayElement;
            }

            // Use Luxon for timezone handling
            const { DateTime } = luxon;

            // Only show popular timezones
            const popularTimezones = [
                "Asia/Kolkata", "Asia/Dubai", "Asia/Singapore", "Asia/Tokyo",
                "Europe/London", "Europe/Berlin", "Europe/Paris", "Europe/Moscow",
                "America/New_York", "America/Chicago", "America/Denver", "America/Los_Angeles",
                "Australia/Sydney"
            ];

            // Populate timezone dropdowns with popular timezones only
            function populateTimezones() {
                timezoneSelect.innerHTML = '';
                popularTimezones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz;
                    option.textContent = tz.replace('_', ' ');
                    if (tz === userTimezone) {
                        option.selected = true;
                    }
                    timezoneSelect.appendChild(option);
                });
                // If user's timezone not in popular list, add it at the top
                if (!popularTimezones.includes(userTimezone)) {
                    const option = document.createElement('option');
                    option.value = userTimezone;
                    option.textContent = userTimezone.replace('_', ' ') + " (Your detected timezone)";
                    option.selected = true;
                    timezoneSelect.insertBefore(option, timezoneSelect.firstChild);
                }
            }

            function populateTeacherTz() {
                teacherSlotTz.innerHTML = '';
                popularTimezones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz;
                    option.textContent = tz.replace('_', ' ');
                    if (tz === 'Asia/Kolkata') option.selected = true;
                    teacherSlotTz.appendChild(option);
                });
            }

            // Show time slots for selected date
            function showTimeSlots() {
                if (!selectedDate) return;

                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                selectedDateText.textContent = selectedDate.toLocaleDateString('en-US', options);

                const timeSlotsGrid = document.querySelector('#time-slots > div');
                timeSlotsGrid.innerHTML = '';

                let slots = [];

                // Convert selectedDate to YYYY-MM-DD for matching
                const dateStr = selectedDate.getFullYear() + '-' +
                    String(selectedDate.getMonth() + 1).padStart(2, '0') + '-' +
                    String(selectedDate.getDate()).padStart(2, '0');

                if (isTeacherView) {
                    const teacherSlot = teacherSlots.find(slot => slot.date === dateStr);
                    if (teacherSlot) {
                        // Show the slot as a block
                        const slotElement = document.createElement('div');
                        slotElement.className = 'bg-indigo-100 border border-indigo-300 rounded-md p-3 mb-2';
                        slotElement.innerHTML = `
                            <div class="font-medium text-gray-800">Available: ${teacherSlot.start} - ${teacherSlot.end} (${teacherSlot.tz})</div>
                            <div class="text-xs text-gray-500">This will be divided into hourly slots for students</div>
                        `;
                        timeSlotsGrid.appendChild(slotElement);
                    } else {
                        timeSlotsGrid.innerHTML = '<div class="text-gray-500">No slots added for this date.</div>';
                    }
                    timeSlotsContainer.classList.add('show');
                    return;
                }

                // Student view: show hourly slots only for teacher-scheduled dates
                const teacherSlot = teacherSlots.find(slot => slot.date === dateStr);
                if (teacherSlot) {
                    const teacherTz = teacherSlot.tz;
                    const studentTz = userTimezone;

                    // Use Luxon to parse start/end in teacher's timezone
                    let start = DateTime.fromISO(`${teacherSlot.date}T${teacherSlot.start}`, { zone: teacherTz });
                    let end = DateTime.fromISO(`${teacherSlot.date}T${teacherSlot.end}`, { zone: teacherTz });

                    // Divide into hourly slots
                    let current = start.setZone(studentTz);
                    let endStudent = end.setZone(studentTz);

                    // Fix: Use .valueOf() for comparison to avoid infinite loop if timezones cause same time
                    while (current.valueOf() < endStudent.valueOf()) {
                        let next = current.plus({ hours: 1 });
                        if (next.valueOf() > endStudent.valueOf()) next = endStudent;

                        // Format time for display in student's timezone
                        const timeString = current.toFormat('hh:mm a');
                        const endString = next.toFormat('hh:mm a');

                        slots.push({
                            time: current.toJSDate(),
                            display: `${timeString} - ${endString}`
                        });

                        current = next;
                    }
                }

                if (slots.length === 0) {
                    timeSlotsGrid.innerHTML = '<div class="text-gray-500">No classes scheduled for this date.</div>';
                    timeSlotsContainer.classList.add('show');
                    return;
                }

                slots.forEach(slot => {
                    const slotElement = document.createElement('button');
                    slotElement.className = 'time-slot bg-white border border-gray-200 rounded-md p-3 text-center hover:border-indigo-300 hover:bg-indigo-50';
                    slotElement.innerHTML = `
                        <div class="font-medium text-gray-800">${slot.display}</div>
                        <div class="text-xs text-gray-500">Available</div>
                    `;
                    slotElement.addEventListener('click', function() {
                        document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected', 'bg-indigo-100', 'border-indigo-300'));
                        slotElement.classList.add('selected', 'bg-indigo-100', 'border-indigo-300');
                        selectedTimeSlot = slot.time;

                        // Send slot info to parent
                        window.parent.postMessage({
                            type: 'calendar-info',
                            date: selectedDate.toISOString().split('T')[0],
                            time: slot.display,
                            timezone: userTimezone
                        }, '*');
                    });
                    timeSlotsGrid.appendChild(slotElement);
                });

                timeSlotsContainer.classList.add('show');
            }

            // Setup event listeners
            function setupEventListeners() {
                // Month navigation
                prevMonthBtn.addEventListener('click', function() {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });

                nextMonthBtn.addEventListener('click', function() {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                // Timezone change
                timezoneSelect.addEventListener('change', function() {
                    userTimezone = this.value;
                    if (selectedDate) {
                        showTimeSlots();
                    }
                });

                // Switch view logic
                switchViewBtn.addEventListener('click', () => {
                    isTeacherView = !isTeacherView;
                    switchViewBtn.textContent = isTeacherView ? 'Switch to Student View' : 'Switch to Teacher View';
                    addTeacherSlotBtn.classList.toggle('hidden', !isTeacherView);
                    showTimeSlots();
                });

                // Show modal to add teacher slot
                addTeacherSlotBtn.addEventListener('click', () => {
                    teacherSlotModal.classList.remove('hidden');
                    teacherSlotDate.value = '';
                    teacherSlotStart.value = '';
                    teacherSlotEnd.value = '';
                });

                // Cancel modal
                teacherSlotCancel.addEventListener('click', () => {
                    teacherSlotModal.classList.add('hidden');
                });

                // Save teacher slot
                teacherSlotSave.addEventListener('click', () => {
                    if (!teacherSlotDate.value || !teacherSlotStart.value || !teacherSlotEnd.value) return;
                    teacherSlots.push({
                        date: teacherSlotDate.value,
                        start: teacherSlotStart.value,
                        end: teacherSlotEnd.value,
                        tz: teacherSlotTz.value
                    });
                    teacherSlotModal.classList.add('hidden');
                    showTimeSlots();
                });
            }

            // Initialize the calendar
            initCalendar();
        });
    </script>
</body>
</html>